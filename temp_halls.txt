using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.RateLimiting;
using NikahSalon.Application.Halls.CreateHall;
using NikahSalon.Application.Halls.DeleteHall;
using NikahSalon.Application.Halls.GetHallById;
using NikahSalon.Application.Halls.GetHalls;
using NikahSalon.Application.Halls.UpdateHall;
using NikahSalon.Application.Schedules.GetSchedulesByHall;

namespace NikahSalon.API.Controllers;

[ApiController]
[Route("api/v1/halls")]
[Authorize]
public sealed class HallsController : ControllerBase
{
    private readonly GetHallsQueryHandler _getHallsHandler;
    private readonly GetHallByIdQueryHandler _getHallByIdHandler;
    private readonly CreateHallCommandHandler _createHandler;
    private readonly UpdateHallCommandHandler _updateHandler;
    private readonly DeleteHallCommandHandler _deleteHandler;
    private readonly GetSchedulesByHallQueryHandler _getSchedulesHandler;
    private readonly CreateHallCommandValidator _createValidator;
    private readonly UpdateHallCommandValidator _updateValidator;

    public HallsController(
        GetHallsQueryHandler getHallsHandler,
        GetHallByIdQueryHandler getHallByIdHandler,
        CreateHallCommandHandler createHandler,
        UpdateHallCommandHandler updateHandler,
        DeleteHallCommandHandler deleteHandler,
        GetSchedulesByHallQueryHandler getSchedulesHandler,
        CreateHallCommandValidator createValidator,
        UpdateHallCommandValidator updateValidator)
    {
        _getHallsHandler = getHallsHandler;
        _getHallByIdHandler = getHallByIdHandler;
        _createHandler = createHandler;
        _updateHandler = updateHandler;
        _deleteHandler = deleteHandler;
        _getSchedulesHandler = getSchedulesHandler;
        _createValidator = createValidator;
        _updateValidator = updateValidator;
    }

    [HttpGet]
    [ProducesResponseType(StatusCodes.Status200OK)]
    public async Task<IActionResult> GetAll(
        [FromQuery] int page = 1,
        [FromQuery] int pageSize = 10,
        [FromQuery] string? search = null,
        CancellationToken ct = default)
    {
        var query = new GetHallsQuery
        {
            Page = page,
            PageSize = pageSize,
            Search = search
        };
        var result = await _getHallsHandler.HandleAsync(query, ct);
        return Ok(result);
    }

    [HttpGet("{id:guid}")]
    [ProducesResponseType(StatusCodes.Status200OK)]
    [ProducesResponseType(StatusCodes.Status404NotFound)]
    public async Task<IActionResult> GetById(Guid id, CancellationToken ct)
    {
        var query = new GetHallByIdQuery { Id = id };
        var hall = await _getHallByIdHandler.HandleAsync(query, ct);
        if (hall is null) return NotFound();
        return Ok(hall);
    }

    [HttpGet("{id:guid}/schedules")]
    [ProducesResponseType(StatusCodes.Status200OK)]
    public async Task<IActionResult> GetSchedules(Guid id, CancellationToken ct)
    {
        var query = new GetSchedulesByHallQuery { HallId = id };
        var items = await _getSchedulesHandler.HandleAsync(query, ct);
        return Ok(items);
    }

    [HttpPost]
    [Authorize(Roles = "Editor")]
    [EnableRateLimiting("WritePolicy")]
    [ProducesResponseType(StatusCodes.Status201Created)]
    [ProducesResponseType(StatusCodes.Status400BadRequest)]
    [ProducesResponseType(StatusCodes.Status429TooManyRequests)]
    public async Task<IActionResult> Create([FromBody] CreateHallRequest request, CancellationToken ct)
    {
        var command = new CreateHallCommand
        {
            Name = request.Name,
            Address = request.Address,
            Capacity = request.Capacity,
            Description = request.Description,
            ImageUrl = request.ImageUrl,
<<<<<<< Updated upstream
            TechnicalDetails = request.TechnicalDetails
=======
            TimeSlots = request.TimeSlots
>>>>>>> Stashed changes
        };
        var validation = await _createValidator.ValidateAsync(command, ct);
        if (!validation.IsValid)
            throw new FluentValidation.ValidationException(validation.Errors);

        var created = await _createHandler.HandleAsync(command, ct);
        return CreatedAtAction(nameof(GetById), new { id = created.Id }, created);
    }

    [HttpPut("{id:guid}")]
    [Authorize(Roles = "Editor")]
    [EnableRateLimiting("WritePolicy")]
    [ProducesResponseType(StatusCodes.Status200OK)]
    [ProducesResponseType(StatusCodes.Status400BadRequest)]
    [ProducesResponseType(StatusCodes.Status404NotFound)]
    [ProducesResponseType(StatusCodes.Status429TooManyRequests)]
    public async Task<IActionResult> Update(Guid id, [FromBody] UpdateHallRequest request, CancellationToken ct)
    {
        var command = new UpdateHallCommand
        {
            Id = id,
            Name = request.Name,
            Address = request.Address,
            Capacity = request.Capacity,
            Description = request.Description,
            ImageUrl = request.ImageUrl,
            TechnicalDetails = request.TechnicalDetails
        };
        var validation = await _updateValidator.ValidateAsync(command, ct);
        if (!validation.IsValid)
            throw new FluentValidation.ValidationException(validation.Errors);

        var updated = await _updateHandler.HandleAsync(command, ct);
        if (updated is null) return NotFound();
        return Ok(updated);
    }

    [HttpDelete("{id:guid}")]
    [Authorize(Roles = "Editor")]
    [EnableRateLimiting("WritePolicy")]
    [ProducesResponseType(StatusCodes.Status204NoContent)]
    [ProducesResponseType(StatusCodes.Status404NotFound)]
    [ProducesResponseType(StatusCodes.Status429TooManyRequests)]
    public async Task<IActionResult> Delete(Guid id, CancellationToken ct)
    {
        var command = new DeleteHallCommand { Id = id };
        var deleted = await _deleteHandler.HandleAsync(command, ct);
        
        if (!deleted)
            return NotFound(new { success = false, message = "Hall not found." });

        return NoContent();
    }
}

public sealed class CreateHallRequest
{
    public string Name { get; set; } = string.Empty;
    public string Address { get; set; } = string.Empty;
    public int Capacity { get; set; }
    public string Description { get; set; } = string.Empty;
    public string ImageUrl { get; set; } = string.Empty;
<<<<<<< Updated upstream
    public string TechnicalDetails { get; set; } = string.Empty;
=======
    /// <summary>İzin verilen başlangıç saatleri (örn. 09:00, 10:30). Verilirse önümüzdeki 30 gün için müsaitlik oluşturulur.</summary>
    public List<string>? TimeSlots { get; set; }
>>>>>>> Stashed changes
}

public sealed class UpdateHallRequest
{
    public string Name { get; set; } = string.Empty;
    public string Address { get; set; } = string.Empty;
    public int Capacity { get; set; }
    public string Description { get; set; } = string.Empty;
    public string ImageUrl { get; set; } = string.Empty;
    public string TechnicalDetails { get; set; } = string.Empty;
}

